# åç«¯éƒ¨ç½² - é˜¿é‡Œäº‘ ECS
# æ„å»ºå¹¶éƒ¨ç½² Node.js åº”ç”¨åˆ°é˜¿é‡Œäº‘ ECS

name: åç«¯éƒ¨ç½² - é˜¿é‡Œäº‘ ECS

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'package.json'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USER: ${{ secrets.ECS_USER }}
  ECS_KEY: ${{ secrets.ECS_SSH_KEY }}
  APP_DIR: /var/www/huangshi-genealogy

jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ° ECS
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --production
      
      - name: ğŸ” è®¾ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ECS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ° ECS
        run: |
          # åˆ›å»ºä¸´æ—¶éƒ¨ç½²åŒ…
          tar -czf deploy.tar.gz \
            server/ \
            package.json \
            package-lock.json
      
          # ä¸Šä¼ åˆ°æœåŠ¡å™¨
          scp -i ~/.ssh/id_rsa deploy.tar.gz ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:~/deploy.tar.gz
      
      - name: ğŸš€ éƒ¨ç½²åˆ° ECS
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} << 'ENDSSH'
            # åœæ­¢æ—§æœåŠ¡
            cd ${{ env.APP_DIR }}
            pm2 stop ${{ secrets.APP_NAME }} || true
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            cp -r server/ server.backup.$(date +%Y%m%d%H%M%S) || true
            
            # è§£å‹æ–°ç‰ˆæœ¬
            rm -rf server/
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz
            
            # å®‰è£…ä¾èµ–
            npm install --production
            
            # å¯åŠ¨æœåŠ¡
            pm2 start server/index.js --name ${{ secrets.APP_NAME }}
            pm2 save
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 3 ä¸ªï¼‰
            ls -t server.backup.* | tail -n +4 | xargs rm -f || true
          ENDSSH
      
      - name: ğŸ§ª å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          ssh -i ~/.ssh/id_rsa ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} << 'ENDSSH'
            pm2 status ${{ secrets.APP_NAME }}
            pm2 logs ${{ secrets.APP_NAME }} --lines 10
          ENDSSH
      
      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… åç«¯éƒ¨ç½²å®Œæˆï¼"
          echo "API åœ°å€ï¼šhttps://${{ secrets.API_DOMAIN }}"
          echo "æœåŠ¡åç§°ï¼š${{ secrets.APP_NAME }}"
