# åç«¯éƒ¨ç½² - Docker é•œåƒæ„å»ºä¸æ¨é€
# æ„å»º Docker é•œåƒå¹¶éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS

name: åç«¯éƒ¨ç½² - Docker

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'package.json'
      - 'Dockerfile'
      - 'docker-compose.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é•œåƒä»“åº“é…ç½®ï¼ˆé˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼‰
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
  IMAGE_NAME: huangshi-api
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USER: ${{ secrets.ECS_USER }}

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€é•œåƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        run: |
          # ä½¿ç”¨ commit SHA ä½œä¸ºæ ‡ç­¾
          echo "tag=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "latest=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¦ æ„å»º Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: |
            ${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.latest }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
      
      - name: ğŸš€ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.latest }}
      
      - name: âœ… é•œåƒæ„å»ºå®Œæˆ
        run: |
          echo "âœ… é•œåƒå·²æ¨é€åˆ°ï¼š"
          echo "  - ${{ steps.meta.outputs.tag }}"
          echo "  - ${{ steps.meta.outputs.latest }}"

  deploy-to-ecs:
    name: éƒ¨ç½²åˆ° ECS
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ” è®¾ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ECS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.ECS_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“ åˆ›å»ºéƒ¨ç½²è„šæœ¬
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          IMAGE="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          LATEST_IMAGE="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "ğŸ”„ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull $IMAGE
          
          echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
          docker stop huangshi-api || true
          docker rm huangshi-api || true
          
          echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --name huangshi-api \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            -e ALLOWED_ORIGINS=https://hxfund.cn,https://www.hxfund.cn \
            -v /var/www/huangshi-genealogy/logs:/app/logs \
            -v /var/www/huangshi-genealogy/server/config:/app/server/config:ro \
            $IMAGE
          
          echo "ğŸ·ï¸ æ›´æ–° latest æ ‡ç­¾..."
          docker tag $IMAGE $LATEST_IMAGE
          
          echo "ğŸ§ª å¥åº·æ£€æŸ¥..."
          sleep 5
          for i in {1..10}; do
            if curl -s http://localhost:3000/api/health > /dev/null; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              exit 0
            fi
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
            sleep 3
          done
          
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
          docker logs huangshi-api
          exit 1
          EOF
          chmod +x deploy.sh
      
      - name: ğŸ“¤ ä¸Šä¼ éƒ¨ç½²è„šæœ¬åˆ° ECS
        run: |
          scp -i ~/.ssh/id_rsa deploy.sh ${{ env.ECS_USER }}@${{ env.ECS_HOST }}:~/deploy.sh
      
      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        run: |
          ssh -i ~/.ssh/id_rsa ${{ env.ECS_USER }}@${{ env.ECS_HOST }} << 'ENDSSH'
            # ç¡®ä¿ Docker å·²å®‰è£…
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
              exit 1
            fi
            
            # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
            docker login --username=${{ secrets.ACR_USERNAME }} --password=${{ secrets.ACR_PASSWORD }} registry.cn-hangzhou.aliyuncs.com
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            bash ~/deploy.sh
            
            # æ¸…ç†
            rm ~/deploy.sh
          ENDSSH
      
      - name: ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€
        run: |
          ssh -i ~/.ssh/id_rsa ${{ env.ECS_USER }}@${{ env.ECS_HOST }} << 'ENDSSH'
            echo "=== å®¹å™¨çŠ¶æ€ ==="
            docker ps -a | grep huangshi-api
            
            echo "=== æœ€è¿‘æ—¥å¿— ==="
            docker logs huangshi-api --tail 20
            
            echo "=== å¥åº·æ£€æŸ¥ ==="
            curl -s http://localhost:3000/api/health | jq || true
          ENDSSH
      
      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… Docker éƒ¨ç½²å®Œæˆï¼"
          echo "API åœ°å€ï¼šhttps://${{ secrets.API_DOMAIN }}"
          echo "é•œåƒï¼š${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
