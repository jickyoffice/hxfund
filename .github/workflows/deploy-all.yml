# å®Œæ•´éƒ¨ç½² - å‰ç«¯ + åç«¯
# åŒæ—¶éƒ¨ç½²å‰ç«¯å’Œåç«¯

name: å®Œæ•´éƒ¨ç½² - å‰ç«¯ + åç«¯

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  build:
    name: æ„å»º
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: npm run build
      
      - name: ğŸ“¦ ä¿å­˜æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7
      
      - name: ğŸ“¦ ä¿å­˜åç«¯ä»£ç 
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: |
            server/
            package.json
            package-lock.json
          retention-days: 7

  deploy-frontend:
    name: éƒ¨ç½²å‰ç«¯
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/
      
      - name: ğŸ“¤ ä¸Šä¼ åˆ°é˜¿é‡Œäº‘è™šæ‹Ÿä¸»æœº (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /htdocs/
          local-dir: ./dist/
          protocol: ftps
          exclude: |
            **/.git*
            **/.git*/**
      
      - name: âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ
        run: echo "âœ… å‰ç«¯å·²éƒ¨ç½²åˆ° https://hxfund.cn"

  deploy-backend:
    name: éƒ¨ç½²åç«¯
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½åç«¯ä»£ç 
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: ./
      
      - name: ğŸ” è®¾ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ECS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“¤ ä¸Šä¼ åˆ° ECS
        run: |
          tar -czf deploy.tar.gz server/ package.json package-lock.json
          scp -i ~/.ssh/id_rsa deploy.tar.gz ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:~/deploy.tar.gz
      
      - name: ğŸš€ éƒ¨ç½²æœåŠ¡
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} << 'ENDSSH'
            cd ${{ secrets.APP_DIR }}
            
            # åœæ­¢æ—§æœåŠ¡
            pm2 stop ${{ secrets.APP_NAME }} || true
            
            # å¤‡ä»½
            cp -r server/ server.backup.$(date +%Y%m%d%H%M%S) || true
            
            # è§£å‹æ–°ç‰ˆæœ¬
            rm -rf server/
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz
            
            # å®‰è£…ä¾èµ–
            npm install --production
            
            # å¯åŠ¨æœåŠ¡
            pm2 start server/index.js --name ${{ secrets.APP_NAME }}
            pm2 save
          ENDSSH
      
      - name: ğŸ§ª å¥åº·æ£€æŸ¥
        run: |
          sleep 5
          ssh -i ~/.ssh/id_rsa ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} << 'ENDSSH'
            curl -s http://localhost:3000/api/health || exit 1
          ENDSSH
      
      - name: âœ… åç«¯éƒ¨ç½²å®Œæˆ
        run: echo "âœ… åç«¯å·²éƒ¨ç½²åˆ° https://${{ secrets.API_DOMAIN }}"
