# é˜¿é‡Œäº‘éƒ¨ç½²é…ç½®è¯´æ˜

## ğŸ“Š éƒ¨ç½²æ¶æ„

| ç»„ä»¶ | é˜¿é‡Œäº‘äº§å“ | é…ç½® | ç”¨é€” |
|------|-----------|------|------|
| **å‰ç«¯** | å…±äº«è™šæ‹Ÿä¸»æœºåŸºç¡€ç‰ˆ | 20GB å­˜å‚¨ / 1G æµé‡ | é™æ€èµ„æºæ‰˜ç®¡ |
| **åç«¯** | ECS äº‘æœåŠ¡å™¨ | 2 æ ¸ 2GiB | Node.js API æœåŠ¡ |

---

## ğŸš€ å‰ç«¯éƒ¨ç½²ï¼ˆè™šæ‹Ÿä¸»æœºï¼‰

### 1. æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
npm run build
```

æ„å»ºå®Œæˆåï¼Œ`dist/` ç›®å½•åŒ…å«æ‰€æœ‰éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š

```
dist/
â”œâ”€â”€ index.html          # ä¸»é¡µé¢
â”œâ”€â”€ css/
â”‚   â””â”€â”€ style.min.css   # å‹ç¼©æ ·å¼
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ data.min.js     # æ•°æ®æ¨¡å—
â”‚   â”œâ”€â”€ main.min.js     # ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ modules.min.js  # åŠŸèƒ½æ¨¡å—
â”‚   â””â”€â”€ script.min.js   # AI å®¢æˆ·ç«¯
â”œâ”€â”€ pwa/
â”‚   â”œâ”€â”€ manifest.json   # PWA é…ç½®
â”‚   â””â”€â”€ service-worker.js
â””â”€â”€ images/             # å›¾ç‰‡èµ„æº
```

### 2. ä¸Šä¼ åˆ°è™šæ‹Ÿä¸»æœº

**æ–¹å¼ä¸€ï¼šFTP ä¸Šä¼ **

1. ä½¿ç”¨ FTP å·¥å…·ï¼ˆå¦‚ FileZillaï¼‰è¿æ¥è™šæ‹Ÿä¸»æœº
2. å°† `dist/` ç›®å½•æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ åˆ° `htdocs/` ç›®å½•
3. ç¡®ä¿ `index.html` åœ¨æ ¹ç›®å½•

**æ–¹å¼äºŒï¼šé˜¿é‡Œäº‘æ§åˆ¶å°**

1. ç™»å½•é˜¿é‡Œäº‘è™šæ‹Ÿä¸»æœºæ§åˆ¶å°
2. è¿›å…¥"æ–‡ä»¶ç®¡ç†"
3. ä¸Šä¼  `dist/` ç›®å½•å†…å®¹åˆ° `htdocs/`

### 3. é…ç½® API åœ°å€

å‰ç«¯éœ€è¦çŸ¥é“åç«¯ API çš„åœ°å€ã€‚ä¿®æ”¹ `public/js/script.js`ï¼š

```javascript
// è·å–è®¤è¯ Token
async function getAuthToken() {
    const response = await fetch('https://api.hxfund.cn/api/auth/client-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
    });
    // ...
}
```

æˆ–è€…åœ¨ `index.html` ä¸­æ·»åŠ å…¨å±€é…ç½®ï¼š

```html
<script>
window.API_CONFIG = {
    baseURL: 'https://api.hxfund.cn'  // åç«¯ API åœ°å€
};
</script>
```

---

## ğŸ–¥ï¸ åç«¯éƒ¨ç½²ï¼ˆECSï¼‰

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# ç™»å½• ECS æœåŠ¡å™¨
ssh root@your-ecs-ip

# å®‰è£… Node.js (v18+)
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# éªŒè¯å®‰è£…
node -v
npm -v
```

### 2. ä¸Šä¼ åç«¯ä»£ç 

```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºåº”ç”¨ç›®å½•
mkdir -p /var/www/huangshi-genealogy
cd /var/www/huangshi-genealogy

# ä¸Šä¼ é¡¹ç›®æ–‡ä»¶ï¼ˆæ’é™¤å‰ç«¯å’Œä¸éœ€è¦æ–‡ä»¶ï¼‰
# æœ¬åœ°æ‰§è¡Œï¼š
scp -r server/ package.json package-lock.json root@your-ecs-ip:/var/www/huangshi-genealogy/
```

### 3. å®‰è£…ä¾èµ–

```bash
cd /var/www/huangshi-genealogy
npm install --production
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åˆ›å»ºç¯å¢ƒé…ç½®
mkdir -p server/config
cat > server/config/.env << EOF
PORT=3000
NODE_ENV=production
ALLOWED_ORIGINS=https://hxfund.cn,https://www.hxfund.cn
REDIS_URL=redis://localhost:6379
EOF
```

### 5. é…ç½®è®¤è¯

```bash
# åˆå§‹åŒ–è®¤è¯é…ç½®
node -e "
const fs = require('fs');
const crypto = require('crypto');
const config = {
  serverApiKey: 'hs_' + crypto.randomBytes(32).toString('hex'),
  jwtSecret: crypto.randomBytes(64).toString('hex'),
  tokenExpiresIn: 86400000,
  rateLimit: {
    windowMs: 60000,
    maxRequests: 30,
    maxChatRequests: 10
  }
};
fs.writeFileSync('server/config/auth.json', JSON.stringify(config, null, 2));
console.log('API Key:', config.serverApiKey);
"
```

### 6. ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨æœåŠ¡
pm2 start server/index.js --name huangshi-api

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### 7. é…ç½® Nginx åå‘ä»£ç†

```bash
# å®‰è£… Nginx
yum install -y nginx

# é…ç½® Nginx
cat > /etc/nginx/conf.d/huangshi.conf << 'EOF'
server {
    listen 80;
    server_name api.hxfund.cn;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# é‡å¯ Nginx
systemctl restart nginx
```

### 8. é…ç½® HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦
yum install -y certbot python3-certbot-nginx
certbot --nginx -d api.hxfund.cn
```

---

## ğŸ”— å‰åç«¯é€šä¿¡é…ç½®

### å‰ç«¯é…ç½® API åœ°å€

åœ¨ `index.html` çš„ `<head>` ä¸­æ·»åŠ ï¼š

```html
<script>
    // API é…ç½®
    window.API_CONFIG = {
        baseURL: 'https://api.hxfund.cn',  // åç«¯ API åŸŸå
        timeout: 30000
    };
</script>
```

### åç«¯é…ç½® CORS

åœ¨ `server/index.js` ä¸­ç¡®ä¿ CORS é…ç½®æ­£ç¡®ï¼š

```javascript
const corsOptions = {
  origin: function (origin, callback) {
    const allowedOrigins = process.env.ALLOWED_ORIGINS
      ? process.env.ALLOWED_ORIGINS.split(',')
      : ['http://localhost:3000'];

    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1 || origin.endsWith('.hxfund.cn')) {
      callback(null, true);
    } else {
      callback(new Error('ä¸å…è®¸çš„è·¨åŸŸè¯·æ±‚'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-API-Key']
};
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å‰ç«¯ï¼ˆè™šæ‹Ÿä¸»æœºï¼‰

- [ ] æ„å»ºç”Ÿäº§ç‰ˆæœ¬ (`npm run build`)
- [ ] ä¸Šä¼  `dist/` åˆ° `htdocs/`
- [ ] é…ç½® API åœ°å€
- [ ] æµ‹è¯•é¡µé¢è®¿é—®
- [ ] æµ‹è¯• API è°ƒç”¨
- [ ] é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆå¦‚ hxfund.cnï¼‰

### åç«¯ï¼ˆECSï¼‰

- [ ] å®‰è£… Node.js ç¯å¢ƒ
- [ ] ä¸Šä¼ åç«¯ä»£ç 
- [ ] å®‰è£…ä¾èµ– (`npm install`)
- [ ] é…ç½®ç¯å¢ƒå˜é‡
- [ ] åˆå§‹åŒ–è®¤è¯é…ç½®
- [ ] ä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡
- [ ] é…ç½® Nginx åå‘ä»£ç†
- [ ] é…ç½® HTTPS è¯ä¹¦
- [ ] é…ç½®é˜²ç«å¢™ï¼ˆå¼€æ”¾ 80/443 ç«¯å£ï¼‰
- [ ] æµ‹è¯• API ç«¯ç‚¹

### åŸŸå DNS é…ç½®

| åŸŸå | ç±»å‹ | å€¼ |
|------|------|-----|
| `hxfund.cn` | A | è™šæ‹Ÿä¸»æœº IP |
| `www.hxfund.cn` | CNAME | `hxfund.cn` |
| `api.hxfund.cn` | A | ECS å…¬ç½‘ IP |

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### å‰ç«¯

```bash
# æ„å»º
npm run build

# æœ¬åœ°æµ‹è¯•
npm run serve
```

### åç«¯

```bash
# æŸ¥çœ‹æ—¥å¿—
pm2 logs huangshi-api

# é‡å¯æœåŠ¡
pm2 restart huangshi-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# åœæ­¢æœåŠ¡
pm2 stop huangshi-api
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æµé‡æ§åˆ¶**: è™šæ‹Ÿä¸»æœºæ¯æœˆ 1G æµé‡ï¼Œæ³¨æ„å›¾ç‰‡ç­‰èµ„æºå¤§å°
2. **CORS é…ç½®**: ç¡®ä¿åç«¯å…è®¸å‰ç«¯åŸŸåè·¨åŸŸè®¿é—®
3. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ä½¿ç”¨ HTTPS
4. **å¤‡ä»½**: å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œè®¤è¯é…ç½®
5. **ç›‘æ§**: é…ç½® ECS ç›‘æ§å‘Šè­¦ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰

---

**éƒ¨ç½²æ—¥æœŸ**: 2026 å¹´ 2 æœˆ 25 æ—¥
**ç‰ˆæœ¬**: v3.3.0
