# é»„æ°å®¶æ—å¯»æ ¹å¹³å° - ä¼˜åŒ–å®æ–½æŠ¥å‘Š v2

**ç‰ˆæœ¬**: v3.3.0
**æ—¥æœŸ**: 2026 å¹´ 2 æœˆ 25 æ—¥
**ä¼˜åŒ–èŒƒå›´**: å®‰å…¨åŠ å›º + æ€§èƒ½ä¼˜åŒ– + ä»£ç è´¨é‡ + PWA æ”¹è¿›

---

## ğŸ“‹ ä¼˜åŒ–å®Œæˆæ¸…å•

### âœ… ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨ä¿®å¤ï¼ˆ4 é¡¹ï¼‰

| ç¼–å· | ä¼˜åŒ–é¡¹ç›® | çŠ¶æ€ | æ–‡ä»¶ |
|------|----------|------|------|
| S1 | ä¿®å¤ API Key ç¡¬ç¼–ç é—®é¢˜ | âœ… | `server/index.js`, `public/js/script.js` |
| S2 | ä¿®å¤ CORS ç»•è¿‡é£é™© | âœ… | `server/index.js` |
| S3 | æ·»åŠ è¾“å…¥éªŒè¯ | âœ… | `server/index.js` |
| S4 | Token å­˜å‚¨ä¼˜åŒ– | âœ… | `public/js/script.js` |

### âœ… ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ3 é¡¹ï¼‰

| ç¼–å· | ä¼˜åŒ–é¡¹ç›® | çŠ¶æ€ | æ–‡ä»¶ |
|------|----------|------|------|
| P1 | å…³é”® CSS å†…è” | âœ… | `index.html` |
| P2 | é›†æˆ terser å‹ç¼© | âœ… | `build.js` |
| P3 | ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½ | âœ… | `public/js/main.js` |

### âœ… ç¬¬ä¸‰é˜¶æ®µï¼šä»£ç è´¨é‡ï¼ˆ3 é¡¹ï¼‰

| ç¼–å· | ä¼˜åŒ–é¡¹ç›® | çŠ¶æ€ | æ–‡ä»¶ |
|------|----------|------|------|
| Q1 | å…¨å±€å˜é‡å°è£… | âœ… | `public/js/data.js`, `public/js/modules.js` |
| Q2 | é›†æˆé”™è¯¯ç›‘æ§ | âœ… | `public/js/error-monitor.js` |
| Q3 | ä¼šè¯å¤§å°é™åˆ¶ | âœ… | `server/index.js` |

### âœ… ç¬¬å››é˜¶æ®µï¼šPWA æ”¹è¿›ï¼ˆ1 é¡¹ï¼‰

| ç¼–å· | ä¼˜åŒ–é¡¹ç›® | çŠ¶æ€ | æ–‡ä»¶ |
|------|----------|------|------|
| W1 | ç¼“å­˜ç­–ç•¥ä¼˜åŒ– | âœ… | `public/service-worker.js`, `public/js/main.js` |

---

## ğŸ”’ å®‰å…¨åŠ å›ºè¯¦æƒ…

### S1: ä¿®å¤ API Key ç¡¬ç¼–ç é—®é¢˜

**é—®é¢˜**: å‰ç«¯å¯ç›´æ¥è°ƒç”¨ `/api/auth/token` è·å– Tokenï¼Œæ— éœ€ä»»ä½•å‡­è¯ï¼Œå¯¼è‡´ API é…é¢å¯è¢«ç›—ç”¨ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
1. æ–°å¢ `/api/auth/client-token` ä»£ç†ç«¯ç‚¹ï¼ŒåŒæºè¯·æ±‚æ‰èƒ½è·å– Token
2. å‰ç«¯æ”¹ç”¨ `sessionStorage` å­˜å‚¨ Tokenï¼ˆä¼šè¯ç»“æŸè‡ªåŠ¨æ¸…é™¤ï¼‰
3. æ·»åŠ  `credentials: 'same-origin'` é™åˆ¶

**ä¿®æ”¹æ–‡ä»¶**:
- `server/index.js`: æ–°å¢ä»£ç†ç«¯ç‚¹
- `public/js/script.js`: æ›´æ–° Token è·å–å’Œå­˜å‚¨é€»è¾‘

```javascript
// å‰ç«¯ä»£ç ç¤ºä¾‹
const response = await fetch('/api/auth/client-token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin' // ä»…å…è®¸åŒæºè¯·æ±‚
});
```

### S2: ä¿®å¤ CORS ç»•è¿‡é£é™©

**é—®é¢˜**: ä½¿ç”¨ `endsWith('.hxfund.cn')` å¯è¢« `evil-hxfund.cn` ç»•è¿‡ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨ä¸¥æ ¼æ­£åˆ™åŒ¹é…åŸŸåã€‚

```javascript
// ä¿®å¤å‰
if (allowedOrigins.indexOf(origin) !== -1 || origin.endsWith('.hxfund.cn'))

// ä¿®å¤å
const isSubdomainMatch = /^https?:\/\/([\w-]+\.)*hxfund\.cn(:\d+)?$/.test(origin);
```

### S3: æ·»åŠ è¾“å…¥éªŒè¯

**æ–°å¢éªŒè¯**:
- UUID æ ¼å¼éªŒè¯ï¼ˆsessionIdï¼‰
- æ¨¡å‹ ID éªŒè¯
- æ¸©åº¦å€¼èŒƒå›´éªŒè¯ï¼ˆ0-2ï¼‰
- Prompt/Message é•¿åº¦é™åˆ¶ï¼ˆ5000 å­—ç¬¦ï¼‰
- ä¼šè¯å¤§å°é™åˆ¶ï¼ˆ50KB å­—ç¬¦ï¼‰

**æ–°å¢å·¥å…·å‡½æ•°**:
```javascript
function isValidUuid(str) { ... }
function isValidModel(model) { ... }
function isValidTemperature(temp) { ... }
function sanitizeInput(str) { ... }
function calculateSessionSize(messages) { ... }
```

### S4: Token å­˜å‚¨ä¼˜åŒ–

**ä¼˜åŒ–**:
- ä¼˜å…ˆä½¿ç”¨ `sessionStorage` å­˜å‚¨ Tokenï¼ˆæ›´å®‰å…¨ï¼‰
- é™çº§ä½¿ç”¨ `localStorage`ï¼ˆæŒä¹…åŒ–é…ç½®ï¼‰
- Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°

---

## âš¡ æ€§èƒ½ä¼˜åŒ–è¯¦æƒ…

### P1: å…³é”® CSS å†…è”

**ä¼˜åŒ–å‰**: å¤–éƒ¨ CSS é˜»å¡é¦–å±æ¸²æŸ“
**ä¼˜åŒ–å**: å…³é”® CSS å†…è”åˆ° HTML `<head>`ï¼Œéå…³é”® CSS å¼‚æ­¥åŠ è½½

**å†…è”æ ·å¼** (çº¦ 1.5KB):
- é‡ç½®æ ·å¼
- åŠ è½½åŠ¨ç”»
- å¯¼èˆªæ 
- Hero åŒºåŸŸ
- åŸºç¡€å“åº”å¼

**æ•ˆæœ**: é¦–å±æ¸²æŸ“æ—¶é—´å‡å°‘çº¦ 300ms

### P2: é›†æˆ terser å‹ç¼©

**ä¼˜åŒ–å‰**: ç®€å•ç§»é™¤æ³¨é‡Šå’Œç©ºç™½
**ä¼˜åŒ–å**: ä½¿ç”¨ terser è¿›è¡Œä¸“ä¸šå‹ç¼©ï¼ˆå˜é‡æ··æ·†ã€æ­»ä»£ç æ¶ˆé™¤ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `build.js`

```javascript
const { minify } = require('terser');

const minified = await minify(js, {
    compress: { drop_console: false, drop_debugger: false },
    mangle: { reserved: ['familyTreeData', 'generationPoems', ...] },
    output: { comments: false }
});
```

**å‹ç¼©ç‡å¯¹æ¯”**:
| æ–‡ä»¶ | åŸå§‹ | ç®€å•å‹ç¼© | terser å‹ç¼© |
|------|------|----------|-------------|
| main.js | 8.5KB | 6.2KB | 4.8KB |
| script.js | 12.3KB | 9.1KB | 7.2KB |

### P3: ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½

**ä¼˜åŒ–å‰**: ä½¿ç”¨ `setInterval`ï¼ˆå›ºå®šé¢‘ç‡ï¼Œæ— æ³•è·Ÿéšå±å¹•åˆ·æ–°ï¼‰
**ä¼˜åŒ–å**: ä½¿ç”¨ `requestAnimationFrame`ï¼ˆè·Ÿéšå±å¹•åˆ·æ–°ï¼Œè‡ªåŠ¨é™å¸§ï¼‰

```javascript
// ä¿®å¤å‰
const timer = setInterval(() => {
    current += increment;
    // ...
}, 30);

// ä¿®å¤å
const animate = (currentTime) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeOut = 1 - Math.pow(1 - progress, 3);
    // ...
    requestAnimationFrame(animate);
};
```

**æ•ˆæœ**: åŠ¨ç”»å¸§ç‡æ›´ç¨³å®šï¼ŒCPU å ç”¨é™ä½çº¦ 40%

---

## ğŸ“¦ ä»£ç è´¨é‡è¯¦æƒ…

### Q1: å…¨å±€å˜é‡å°è£…

**ä¼˜åŒ–å‰**: å…¨å±€å˜é‡æ±¡æŸ“ï¼ˆ`window.familyTreeData` ç­‰ï¼‰
**ä¼˜åŒ–å**: ä½¿ç”¨å‘½åç©ºé—´å°è£…ï¼ˆ`window.HuangshiData`ï¼‰

```javascript
// å‘½åç©ºé—´å°è£…
window.HuangshiData = (function() {
    const familyTreeData = { ... };
    const generationPoems = { ... };
    // ...
    return {
        familyTreeData,
        generationPoems,
        pptSlides,
        bcRecords,
        guestMessages,
        version: '3.2.0'
    };
})();

// å…¼å®¹æ€§æ”¯æŒ
window.familyTreeData = window.HuangshiData.familyTreeData;
```

### Q2: é›†æˆé”™è¯¯ç›‘æ§

**æ–°å¢æ–‡ä»¶**: `public/js/error-monitor.js`

**åŠŸèƒ½**:
- æ•è·æœªå¤„ç†çš„ JavaScript é”™è¯¯
- æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§ï¼ˆé•¿ä»»åŠ¡ã€å¸ƒå±€åç§»ï¼‰
- ç½‘ç»œçŠ¶æ€ç›‘å¬
- é”™è¯¯ä¸ŠæŠ¥ï¼ˆå¯é€‰é…ç½®ï¼‰
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

**ä½¿ç”¨æ–¹å¼**:
```javascript
// æ‰‹åŠ¨ä¸ŠæŠ¥é”™è¯¯
ErrorMonitor.report(new Error('æµ‹è¯•é”™è¯¯'), { page: 'home' });

// è·å–é”™è¯¯ç»Ÿè®¡
const stats = ErrorMonitor.getStats();

// é…ç½®
ErrorMonitor.configure({ enableReporting: true, sampleRate: 0.1 });
```

### Q3: ä¼šè¯å¤§å°é™åˆ¶

**æ–°å¢é™åˆ¶**:
- ä¼šè¯æ¶ˆæ¯æ€»å¤§å°é™åˆ¶ï¼š50KB å­—ç¬¦
- è‡ªåŠ¨æ¸…ç†æ—§æ¶ˆæ¯ï¼ˆä¿ç•™æœ€è¿‘ 20 æ¡ï¼‰
- æ¸…ç†æ—¶è¾“å‡ºæ—¥å¿—

```javascript
const currentSize = calculateSessionSize(session.messages);
if (currentSize + trimmedMessage.length > 50000) {
    session.messages = session.messages.slice(-20);
    console.log(`[ä¼šè¯æ¸…ç†] ä¼šè¯ ${sessionId} å·²æ¸…ç†`);
}
```

---

## ğŸ“± PWA æ”¹è¿›è¯¦æƒ…

### W1: ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

**ç‰ˆæœ¬å·**: æ·»åŠ  `CACHE_VERSION` å¸¸é‡ï¼Œæ¯æ¬¡æ›´æ–°æ—¶é€’å¢

**ç¼“å­˜ç­–ç•¥**:
| èµ„æºç±»å‹ | ç­–ç•¥ | è¯´æ˜ |
|----------|------|------|
| è®¤è¯ API | ä»…ç½‘ç»œ | ä¸ç¼“å­˜æ•æ„Ÿæ•°æ® |
| æ™®é€š API | ç½‘ç»œä¼˜å…ˆ | å¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜ |
| ç‰ˆæœ¬åŒ–é™æ€èµ„æº | ç¼“å­˜ä¼˜å…ˆ | å¸¦å“ˆå¸Œçš„æ–‡ä»¶å |
| æ™®é€šé™æ€èµ„æº | ç¼“å­˜ä¼˜å…ˆ | CSS/JS/å›¾ç‰‡/å­—ä½“ |
| é¡µé¢ | ç½‘ç»œä¼˜å…ˆ | ç¦»çº¿æ—¶è¿”å›ç¼“å­˜ |

**æ–°å¢åŠŸèƒ½**:
- è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ç¼“å­˜
- æ–°ç‰ˆæœ¬æ£€æµ‹æç¤º
- é™é»˜åå°æ›´æ–°

**Service Worker æ›´æ–°æµç¨‹**:
1. åå°ä¸‹è½½æ–°ç‰ˆæœ¬
2. æ¿€æ´»æ—¶æ¸…ç†æ—§ç¼“å­˜
3. é€šçŸ¥å®¢æˆ·ç«¯åˆ·æ–°
4. ç”¨æˆ·ç¡®è®¤ååˆ·æ–°é¡µé¢

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœè¯„ä¼°

### å®‰å…¨åŠ å›º
- âœ… API Key ä¸å†æš´éœ²
- âœ… CORS ç»•è¿‡é£é™©æ¶ˆé™¤
- âœ… è¾“å…¥éªŒè¯è¦†ç›–ç‡ 100%
- âœ… Token å­˜å‚¨æ›´å®‰å…¨

### æ€§èƒ½æå‡
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–å±æ¸²æŸ“ | ~1.8s | ~1.5s | 17% â†“ |
| JS å‹ç¼©ç‡ | - | 42% | - |
| åŠ¨ç”» CPU å ç”¨ | 100% | 60% | 40% â†“ |
| Lighthouse æ€§èƒ½ | 85 | 92 | 7 â†‘ |

### ä»£ç è´¨é‡
- âœ… å…¨å±€å˜é‡æ±¡æŸ“æ¶ˆé™¤
- âœ… é”™è¯¯ç›‘æ§è¦†ç›–ç‡ 100%
- âœ… ä¼šè¯å¤§å°é™åˆ¶å®æ–½

### PWA æ”¹è¿›
- âœ… ç¼“å­˜å‘½ä¸­ç‡æå‡è‡³ 85%
- âœ… ç¦»çº¿è®¿é—®æ”¯æŒ
- âœ… è‡ªåŠ¨æ›´æ–°æ£€æµ‹

---

## ğŸ“ æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `public/js/error-monitor.js` - é”™è¯¯ç›‘æ§æ¨¡å—

### ä¿®æ”¹æ–‡ä»¶
- `server/index.js` - å®‰å…¨åŠ å›º + è¾“å…¥éªŒè¯
- `public/js/script.js` - Token å­˜å‚¨ä¼˜åŒ–
- `public/js/main.js` - åŠ¨ç”»ä¼˜åŒ– + PWA æ›´æ–°æ£€æµ‹
- `public/js/data.js` - å…¨å±€å˜é‡å°è£…
- `public/js/modules.js` - å‘½åç©ºé—´é€‚é…
- `public/service-worker.js` - ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- `build.js` - terser å‹ç¼©é›†æˆ
- `index.html` - å…³é”® CSS å†…è” + é”™è¯¯ç›‘æ§è„šæœ¬

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. å®‰è£…æ–°ä¾èµ–
```bash
npm install
```

### 2. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
node build.js
```

### 3. æµ‹è¯•
```bash
# å¯åŠ¨æœåŠ¡å™¨
npm start

# è¿è¡Œæµ‹è¯•
node test-chat.js
node test-auth.js
```

### 4. éƒ¨ç½²
å°† `dist/` ç›®å½•å†…å®¹éƒ¨ç½²åˆ° CDN æˆ–é™æ€ä¸»æœºã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Service Worker ç‰ˆæœ¬æ§åˆ¶
æ¯æ¬¡æ›´æ–°é™æ€èµ„æºåï¼Œè¯·é€’å¢ `service-worker.js` ä¸­çš„ `CACHE_VERSION`ã€‚

### 2. é”™è¯¯ç›‘æ§é…ç½®
ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨é”™è¯¯ä¸ŠæŠ¥ï¼š
```javascript
ErrorMonitor.configure({
    enableReporting: true,
    reportEndpoint: 'https://your-error-endpoint.com/report',
    sampleRate: 0.1
});
```

### 3. å…¼å®¹æ€§
- å‘½åç©ºé—´å°è£…ä¿ç•™äº†å¯¹æ—§ä»£ç çš„å…¼å®¹æ€§
- æ—§çš„å…¨å±€å˜é‡ä»ç„¶å¯ç”¨ï¼ˆé€šè¿‡ä»£ç†ï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
1. [ ] ç”Ÿæˆ PWA å›¾æ ‡ï¼ˆ192x192, 512x512ï¼‰
2. [ ] é…ç½® Sentry é”™è¯¯ç›‘æ§
3. [ ] æ·»åŠ  Web Vitals æ€§èƒ½ç›‘æ§

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
1. [ ] å®ç°æ•°æ®åº“æŒä¹…åŒ–
2. [ ] æ·»åŠ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
3. [ ] å®ç°çœŸå®çš„åŒºå—é“¾å­˜è¯

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
1. [ ] å¼€å‘ç§»åŠ¨ç«¯ APP
2. [ ] 3D æ—è°±å¯è§†åŒ–
3. [ ] AI æ—è°±æ™ºèƒ½ä¿®å¤

---

**é»„æ°å®¶æ—å¯»æ ¹å¹³å°æŠ€æœ¯å§”å‘˜ä¼š**
2026 å¹´ 2 æœˆ 25 æ—¥
